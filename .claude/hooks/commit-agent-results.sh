#!/bin/bash
# commit-agent-results.sh - Auto-commit test results when agents complete

# Parse input
INPUT=$(cat)
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id // "unknown"')

# Check if we're in a git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Not in a git repository - skipping commit" >&2
    exit 0
fi

# Wait a moment to ensure all file operations are complete
sleep 1

# Stage all test results and context logs
git add .claude/test-results/ 2>/dev/null || true
git add .claude/context-logs/ 2>/dev/null || true
git add .claude/context-flow.jsonl 2>/dev/null || true
git add .claude/agent-flow.log 2>/dev/null || true

# Also stage any test files that were created
git add tool-test-files/ 2>/dev/null || true

# Check if there are changes to commit
if ! git diff --cached --quiet; then
    # Count the changes
    FILES_CHANGED=$(git diff --cached --name-only | wc -l)
    
    # Create detailed commit message
    COMMIT_MSG="Auto-commit: Agent test completed - Session ${SESSION_ID:0:8}

Test results captured at $TIMESTAMP
Files changed: $FILES_CHANGED

Context tracking files:
- .claude/context-logs/context-flow.jsonl
- .claude/context-logs/agent-invocations.log
- .claude/context-logs/file-operations.log

[Generated by Claude Code context tracking hooks]"

    git commit -m "$COMMIT_MSG"
    
    echo "‚úÖ Committed test results for session ${SESSION_ID:0:8}"
    
    # Try to push if remote exists
    if git remote get-url origin > /dev/null 2>&1; then
        echo "üì§ Attempting to push to remote..."
        if git push origin HEAD 2>/dev/null; then
            echo "‚úÖ Pushed to remote successfully"
        else
            echo "‚ö†Ô∏è  Push failed - manual push required"
        fi
    fi
else
    echo "No changes to commit"
fi

exit 0
